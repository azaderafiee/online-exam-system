<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ویرایش سوال</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: #f5f5f5;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/instructor/courses/{id}/questions(id=${course.id})}">
            <i class="fas fa-arrow-right"></i> بازگشت به بانک سوالات
        </a>
    </div>
</nav>

<div class="container-fluid mt-4">

    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="mb-1">
                <i class="fas fa-edit text-warning"></i>
                ویرایش سوال
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/instructor/dashboard}">داشبورد</a></li>
                    <li class="breadcrumb-item">
                        <a th:href="@{/instructor/courses/{id}/questions(id=${course.id})}">بانک سوالات</a>
                    </li>
                    <li class="breadcrumb-item active">ویرایش سوال</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form id="questionForm">
                        <input type="hidden" id="questionId" th:value="${question.id}">
                        <input type="hidden" id="courseId" th:value="${course.id}">

                        <!-- نوع سوال (فقط نمایش) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">نوع سوال</label>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <span th:if="${question.type.name() == 'MULTIPLE_CHOICE'}">
                                    <i class="fas fa-list-ul me-2"></i>چندگزینه‌ای
                                </span>
                                <span th:if="${question.type.name() == 'DESCRIPTIVE'}">
                                    <i class="fas fa-align-left me-2"></i>تشریحی
                                </span>
                                <small class="d-block mt-1">نوع سوال قابل تغییر نیست</small>
                            </div>
                        </div>

                        <!-- عنوان سوال -->
                        <div class="mb-3">
                            <label for="title" class="form-label fw-bold">عنوان سوال *</label>
                            <input type="text" class="form-control" id="title" required
                                   th:value="${question.title}"
                                   placeholder="عنوان کوتاه برای سوال">
                        </div>

                        <!-- متن سوال -->
                        <div class="mb-3">
                            <label for="questionText" class="form-label fw-bold">صورت سوال *</label>
                            <textarea class="form-control" id="questionText" rows="4" required
                                      placeholder="صورت کامل سوال را وارد کنید..."
                                      th:text="${question.questionText}"></textarea>
                        </div>

                        <!-- بخش گزینه‌های چندگزینه‌ای -->
                        <div id="multipleChoiceSection" th:if="${question.type.name() == 'MULTIPLE_CHOICE'}">
                            <hr class="my-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">گزینه‌های سوال</h5>
                                <button type="button" class="btn btn-sm btn-success" id="addOptionBtn">
                                    <i class="fas fa-plus me-1"></i>
                                    افزودن گزینه
                                </button>
                            </div>
                            <div id="optionsContainer">
                                <!-- گزینه‌های موجود -->
                                <div th:each="option, iterStat : ${question.options}"
                                     th:id="'option' + ${option.id}"
                                     class="card mb-2 existing-option">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-md-1 text-center">
                                                <div class="form-check">
                                                    <input class="form-check-input correct-radio" type="radio"
                                                           name="correctOption"
                                                           th:value="${option.id}"
                                                           th:id="'correct' + ${option.id}"
                                                           th:checked="${option.isCorrect}">
                                                    <label class="form-check-label" th:for="'correct' + ${option.id}" title="پاسخ صحیح">
                                                        <i class="fas fa-check-circle text-success"></i>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-10">
                                                <input type="text" class="form-control option-text"
                                                       th:value="${option.optionText}"
                                                       th:data-option-id="${option.id}"
                                                       placeholder="متن گزینه" required>
                                            </div>
                                            <div class="col-md-1 text-center">
                                                <button type="button" class="btn btn-sm btn-danger remove-option-btn"
                                                        th:data-option-id="${option.id}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">* دقیقاً یک گزینه باید به عنوان پاسخ صحیح انتخاب شود</small>
                        </div>

                        <!-- بخش سوال تشریحی -->
                        <div id="descriptiveSection" th:if="${question.type.name() == 'DESCRIPTIVE'}">
                            <hr class="my-4">
                            <h5 class="mb-3">تنظیمات سوال تشریحی</h5>

                            <div class="mb-3">
                                <label for="sampleAnswer" class="form-label">پاسخ نمونه (اختیاری)</label>
                                <textarea class="form-control" id="sampleAnswer" rows="3"
                                          placeholder="پاسخ نمونه برای راهنمایی در تصحیح..."
                                          th:text="${question.sampleAnswer}"></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="maxWords" class="form-label">حداکثر تعداد کلمات (اختیاری)</label>
                                <input type="number" class="form-control" id="maxWords" min="1"
                                       th:value="${question.maxWords}"
                                       placeholder="مثلاً: 200">
                                <small class="text-muted">در صورت عدم تعیین، محدودیتی اعمال نمی‌شود</small>
                            </div>
                        </div>

                        <!-- دکمه‌های عملیات -->
                        <hr class="my-4">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="history.back()">
                                <i class="fas fa-times me-2"></i>
                                انصراف
                            </button>
                            <button type="submit" class="btn btn-warning" id="submitBtn">
                                <i class="fas fa-save me-2"></i>
                                به‌روزرسانی سوال
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const questionType = /*[[${question.type.name()}]]*/ 'MULTIPLE_CHOICE';
    let optionCount = /*[[${question.options != null ? question.options.size() : 0}]]*/ 0;
    let newOptionCounter = 0; // برای گزینه‌های جدید

    // افزودن گزینه جدید
    if (document.getElementById('addOptionBtn')) {
        document.getElementById('addOptionBtn').addEventListener('click', addOption);
    }

    function addOption() {
        newOptionCounter++;
        const tempId = 'new_' + newOptionCounter;

        const optionHtml = `
            <div class="card mb-2" id="option${tempId}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-1 text-center">
                            <div class="form-check">
                                <input class="form-check-input correct-radio" type="radio"
                                       name="correctOption" value="${tempId}"
                                       id="correct${tempId}">
                                <label class="form-check-label" for="correct${tempId}" title="پاسخ صحیح">
                                    <i class="fas fa-check-circle text-success"></i>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-10">
                            <input type="text" class="form-control option-text"
                                   data-option-id="${tempId}"
                                   placeholder="متن گزینه جدید" required>
                        </div>
                        <div class="col-md-1 text-center">
                            <button type="button" class="btn btn-sm btn-danger"
                                    onclick="document.getElementById('option${tempId}').remove()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('optionsContainer').insertAdjacentHTML('beforeend', optionHtml);
    }

    // حذف گزینه‌های موجود
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-option-btn')) {
            const btn = e.target.closest('.remove-option-btn');
            const optionId = btn.dataset.optionId;
            if (confirm('آیا از حذف این گزینه اطمینان دارید؟')) {
                document.getElementById('option' + optionId).remove();
            }
        }
    });

    // ارسال فرم
    document.getElementById('questionForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const questionId = document.getElementById('questionId').value;
        const courseId = document.getElementById('courseId').value;
        const title = document.getElementById('title').value.trim();
        const questionText = document.getElementById('questionText').value.trim();

        if (!title || !questionText) {
            alert('لطفاً عنوان و صورت سوال را وارد کنید');
            return;
        }

        let requestData = {
            courseId: parseInt(courseId),
            title: title,
            questionText: questionText
        };

        let apiEndpoint;

        if (questionType === 'MULTIPLE_CHOICE') {
            // جمع‌آوری گزینه‌ها
            const options = [];
            const correctRadio = document.querySelector('input[name="correctOption"]:checked');

            if (!correctRadio) {
                alert('لطفاً یک گزینه را به عنوان پاسخ صحیح انتخاب کنید');
                return;
            }

            const correctOptionId = correctRadio.value;

            document.querySelectorAll('.option-text').forEach((input, index) => {
                if (input.value.trim()) {
                    const optionId = input.dataset.optionId;
                    const isNew = optionId.startsWith('new_');

                    options.push({
                        id: isNew ? null : parseInt(optionId),
                        optionText: input.value.trim(),
                        isCorrect: optionId === correctOptionId,
                        orderIndex: index
                    });
                }
            });

            if (options.length < 2) {
                alert('حداقل دو گزینه برای سوال چندگزینه‌ای لازم است');
                return;
            }

            requestData.options = options;
            apiEndpoint = `/api/questions/${questionId}/multiple-choice`;

        } else {
            // سوال تشریحی
            requestData.sampleAnswer = document.getElementById('sampleAnswer').value.trim() || null;
            const maxWords = document.getElementById('maxWords').value;
            requestData.maxWords = maxWords ? parseInt(maxWords) : null;
            apiEndpoint = `/api/questions/${questionId}/descriptive`;
        }

        // غیرفعال کردن دکمه submit
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>در حال به‌روزرسانی...';

        try {
            const response = await fetch(apiEndpoint, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            if (response.ok) {
                alert('سوال با موفقیت به‌روزرسانی شد');
                window.location.href = `/instructor/courses/${courseId}/questions`;
            } else {
                const error = await response.json();
                alert('خطا: ' + (error.message || 'خطا در به‌روزرسانی سوال'));
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>به‌روزرسانی سوال';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('خطا در ارتباط با سرور');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>به‌روزرسانی سوال';
        }
    });
    /*]]>*/
</script>

</body>
</html>