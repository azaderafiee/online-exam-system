<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت آزمون‌ها</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: #f5f5f5;
        }

        .course-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .exam-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .exam-card:hover {
            transform: translateY(-3px);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .date-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="/instructor/courses">
            <i class="fas fa-arrow-right"></i> بازگشت به دوره‌ها
        </a>
        <div class="btn-group" role="group">
            <a th:href="@{/instructor/courses/{id}/questions(id=${courseId})}"
               class="btn btn-info">
                <i class="fas fa-database"></i> بانک سوالات
            </a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createExamModal">
                <i class="fas fa-plus"></i> ایجاد آزمون جدید
            </button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="course-header">
        <h2 class="mb-2">
            <i class="fas fa-book"></i>
            <span th:text="${course.title}">عنوان دوره</span>
        </h2>
        <p class="mb-2">
            <span class="badge bg-light text-dark me-2" th:text="${course.courseCode}">کد دوره</span>
            <span>
                    <i class="fas fa-user-graduate"></i>
                    <span th:text="${course.studentCount}">0</span> دانشجو
                </span>
        </p>
        <p class="mb-0">
            <i class="fas fa-calendar"></i>
            <strong>بازه زمانی دوره:</strong>
            <span th:text="${#temporals.format(course.startDate, 'yyyy/MM/dd')}"></span>
            تا
            <span th:text="${#temporals.format(course.endDate, 'yyyy/MM/dd')}"></span>
        </p>
    </div>

    <div id="alert-container"></div>

    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="fas fa-file-alt"></i> آزمون‌های این دوره
            </h4>
        </div>
        <div class="card-body">
            <div th:if="${exams.size() == 0}" class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                هنوز آزمونی برای این دوره ایجاد نشده است
            </div>

            <div th:each="exam : ${exams}" class="exam-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2">
                            <i class="fas fa-file-alt text-primary"></i>
                            <span th:text="${exam.title}">عنوان آزمون</span>
                        </h5>
                        <p class="text-muted mb-2" th:text="${exam.description}">توضیحات</p>
                        <div>
                            <span class="badge bg-danger me-2">
                                    <i class="fas fa-calendar-day"></i>
                                    <span th:text="${#temporals.format(exam.examDateTime, 'yyyy/MM/dd HH:mm')}">تاریخ</span>
                                </span>
                            <span class="badge bg-info me-2">
                                    <i class="fas fa-clock"></i>
                                    <span th:text="${exam.durationMinutes}">60</span> دقیقه
                                </span>
                            <span class="badge bg-secondary">
                                    <i class="fas fa-calendar-plus"></i>
                                    ایجاد: <span
                                    th:text="${#temporals.format(exam.createdAt, 'yyyy/MM/dd')}">تاریخ</span>
                                </span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group">

                            <button class="btn btn-sm btn-primary">
                                <a  class="btn btn-sm btn-primary" th:href="@{/instructor/exams/{id}/questions-manager(id=${exam.id})}"
                                   title="مدیریت سوالات">
                                    <i class="fas fa-list-ul"></i> سوالات
                                </a>
                            </button>
                            <button class="btn btn-sm btn-warning"
                                    th:onclick="'editExam(' + ${exam.id} + ')'">
                                <i class="fas fa-edit"></i> ویرایش
                            </button>
                            <button class="btn btn-sm btn-danger"
                                    th:onclick="'deleteExam(' + ${exam.id} + ')'">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="createExamModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> ایجاد آزمون جدید
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>بازه زمانی دوره:</strong>
                    <span th:text="${#temporals.format(course.startDate, 'yyyy/MM/dd')}"></span>
                    تا
                    <span th:text="${#temporals.format(course.endDate, 'yyyy/MM/dd')}"></span>
                    <br>
                    <small>تاریخ آزمون باید در این بازه باشد</small>
                </div>

                <form id="createExamForm">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-heading"></i> عنوان آزمون *
                        </label>
                        <input type="text" class="form-control" id="createTitle" required
                               placeholder="مثال: آزمون میان‌ترم">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-align-left"></i> توضیحات
                        </label>
                        <textarea class="form-control" id="createDescription" rows="3"
                                  placeholder="توضیحات مختصری درباره آزمون..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-calendar-day"></i> تاریخ آزمون *
                            </label>
                            <input type="date" class="form-control" id="createExamDate" required
                                   th:min="${course.startDate}"
                                   th:max="${course.endDate}">
                            <small class="text-muted">تاریخ باید در بازه دوره باشد</small>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-clock"></i> ساعت شروع آزمون *
                            </label>
                            <input type="time" class="form-control" id="createExamTime" required
                                   value="09:00">
                            <small class="text-muted">مثال: 09:00 یا 14:30</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-hourglass-half"></i> مدت زمان آزمون (دقیقه) *
                        </label>
                        <input type="number" class="form-control" id="createDuration" required min="1"
                               placeholder="مثال: 60">
                        <small class="text-muted">مدت زمان به دقیقه</small>
                    </div>

                    <div class="date-warning" id="createDatePreview" style="display: none;">
                        <i class="fas fa-calendar-check"></i>
                        <strong>پیش‌نمایش:</strong>
                        <span id="createDatePreviewText"></span>
                    </div>

                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>توجه:</strong>
                        <ul class="mb-0 mt-2">
                            <li>تاریخ آزمون نمی‌تواند در گذشته باشد</li>
                            <li>تاریخ آزمون باید در بازه زمانی دوره باشد</li>
                            <li>پس از ایجاد آزمون، می‌توانید سوالات را اضافه کنید</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> انصراف
                </button>
                <button type="button" class="btn btn-primary" onclick="createExam()">
                    <i class="fas fa-save"></i> ایجاد آزمون
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editExamModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> ویرایش آزمون
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>بازه زمانی دوره:</strong>
                    <span th:text="${#temporals.format(course.startDate, 'yyyy/MM/dd')}"></span>
                    تا
                    <span th:text="${#temporals.format(course.endDate, 'yyyy/MM/dd')}"></span>
                </div>

                <form id="editExamForm">
                    <input type="hidden" id="editExamId">

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-heading"></i> عنوان آزمون *
                        </label>
                        <input type="text" class="form-control" id="editTitle" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-align-left"></i> توضیحات
                        </label>
                        <textarea class="form-control" id="editDescription" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-calendar-day"></i> تاریخ آزمون *
                            </label>
                            <input type="date" class="form-control" id="editExamDate" required
                                   th:min="${course.startDate}"
                                   th:max="${course.endDate}">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-clock"></i> ساعت شروع آزمون *
                            </label>
                            <input type="time" class="form-control" id="editExamTime" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-hourglass-half"></i> مدت زمان آزمون (دقیقه) *
                        </label>
                        <input type="number" class="form-control" id="editDuration" required min="1">
                    </div>

                    <div class="date-warning" id="editDatePreview" style="display: none;">
                        <i class="fas fa-calendar-check"></i>
                        <strong>پیش‌نمایش:</strong>
                        <span id="editDatePreviewText"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> انصراف
                </button>
                <button type="button" class="btn btn-primary" onclick="saveExamChanges()">
                    <i class="fas fa-save"></i> ذخیره تغییرات
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const courseId = /*[[${courseId}]]*/ 1;
    const courseStartDate = /*[[${course.startDate}]]*/ '2024-01-01';
    const courseEndDate = /*[[${course.endDate}]]*/ '2024-12-31';

    function combineDateTime(dateStr, timeStr) {
        return `${dateStr}T${timeStr}:00`;
    }

    function validateExamDate(dateStr) {
        const examDate = new Date(dateStr);
        const startDate = new Date(courseStartDate);
        const endDate = new Date(courseEndDate);
        const now = new Date();

        if (examDate < now) {
            return {valid: false, message: 'تاریخ آزمون نمی‌تواند در گذشته باشد'};
        }

        if (examDate < startDate) {
            return {valid: false, message: 'تاریخ آزمون نمی‌تواند قبل از شروع دوره باشد'};
        }

        if (examDate > endDate) {
            return {valid: false, message: 'تاریخ آزمون نمی‌تواند بعد از پایان دوره باشد'};
        }

        return {valid: true};
    }

    document.getElementById('createExamDate')?.addEventListener('change', updateCreatePreview);
    document.getElementById('createExamTime')?.addEventListener('change', updateCreatePreview);

    function updateCreatePreview() {
        const dateInput = document.getElementById('createExamDate');
        const timeInput = document.getElementById('createExamTime');
        const preview = document.getElementById('createDatePreview');
        const previewText = document.getElementById('createDatePreviewText');

        if (dateInput.value && timeInput.value) {
            const dateTime = combineDateTime(dateInput.value, timeInput.value);
            const formatted = new Date(dateTime).toLocaleString('fa-IR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const validation = validateExamDate(dateInput.value);
            if (!validation.valid) {
                preview.style.display = 'block';
                preview.style.background = '#f8d7da';
                preview.style.borderColor = '#dc3545';
                previewText.innerHTML = `<span class="text-danger">${validation.message}</span>`;
            } else {
                preview.style.display = 'block';
                preview.style.background = '#d1e7dd';
                preview.style.borderColor = '#28a745';
                previewText.innerHTML = `<span class="text-success">آزمون در ${formatted} برگزار می‌شود</span>`;
            }
        }
    }

    document.getElementById('editExamDate')?.addEventListener('change', updateEditPreview);
    document.getElementById('editExamTime')?.addEventListener('change', updateEditPreview);

    function updateEditPreview() {
        const dateInput = document.getElementById('editExamDate');
        const timeInput = document.getElementById('editExamTime');
        const preview = document.getElementById('editDatePreview');
        const previewText = document.getElementById('editDatePreviewText');

        if (dateInput.value && timeInput.value) {
            const dateTime = combineDateTime(dateInput.value, timeInput.value);
            const formatted = new Date(dateTime).toLocaleString('fa-IR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const validation = validateExamDate(dateInput.value);
            if (!validation.valid) {
                preview.style.display = 'block';
                preview.style.background = '#f8d7da';
                preview.style.borderColor = '#dc3545';
                previewText.innerHTML = `<span class="text-danger">${validation.message}</span>`;
            } else {
                preview.style.display = 'block';
                preview.style.background = '#d1e7dd';
                preview.style.borderColor = '#28a745';
                previewText.innerHTML = `<span class="text-success">آزمون در ${formatted} برگزار می‌شود</span>`;
            }
        }
    }

    async function createExam() {
        const title = document.getElementById('createTitle').value.trim();
        const description = document.getElementById('createDescription').value.trim();
        const duration = document.getElementById('createDuration').value;
        const examDate = document.getElementById('createExamDate').value;
        const examTime = document.getElementById('createExamTime').value;

        if (!title || !duration || !examDate || !examTime) {
            alert('لطفاً تمام فیلدهای الزامی را پر کنید');
            return;
        }

        const validation = validateExamDate(examDate);
        if (!validation.valid) {
            alert(validation.message);
            return;
        }

        const examDateTime = combineDateTime(examDate, examTime);

        const data = {
            courseId: courseId,
            title: title,
            description: description,
            durationMinutes: parseInt(duration),
            examDateTime: examDateTime
        };

        try {
            const response = await fetch('/api/exams', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('createExamModal')).hide();
                showAlert('success', 'آزمون با موفقیت ایجاد شد!');
                setTimeout(() => location.reload(), 1000);
            } else {
                const error = await response.json();
                showAlert('danger', error.message || 'خطا در ایجاد آزمون');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('danger', 'خطا در ارتباط با سرور');
        }
    }

    async function editExam(examId) {
        try {
            const response = await fetch(`/api/exams/${examId}`);
            const exam = await response.json();

            document.getElementById('editExamId').value = exam.id;
            document.getElementById('editTitle').value = exam.title;
            document.getElementById('editDescription').value = exam.description || '';
            document.getElementById('editDuration').value = exam.durationMinutes;

            const examDateTime = new Date(exam.examDateTime);
            const dateStr = examDateTime.toISOString().split('T')[0];
            const timeStr = examDateTime.toTimeString().substr(0, 5);

            document.getElementById('editExamDate').value = dateStr;
            document.getElementById('editExamTime').value = timeStr;

            updateEditPreview();

            new bootstrap.Modal(document.getElementById('editExamModal')).show();
        } catch (error) {
            console.error('Error:', error);
            showAlert('danger', 'خطا در دریافت اطلاعات آزمون');
        }
    }

    async function saveExamChanges() {
        const examId = document.getElementById('editExamId').value;
        const title = document.getElementById('editTitle').value.trim();
        const description = document.getElementById('editDescription').value.trim();
        const duration = document.getElementById('editDuration').value;
        const examDate = document.getElementById('editExamDate').value;
        const examTime = document.getElementById('editExamTime').value;

        if (!title || !duration || !examDate || !examTime) {
            alert('لطفاً تمام فیلدهای الزامی را پر کنید');
            return;
        }

        const validation = validateExamDate(examDate);
        if (!validation.valid) {
            alert(validation.message);
            return;
        }

        const examDateTime = combineDateTime(examDate, examTime);

        const data = {
            title: title,
            description: description,
            durationMinutes: parseInt(duration),
            examDateTime: examDateTime
        };

        try {
            const response = await fetch(`/api/exams/${examId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editExamModal')).hide();
                showAlert('success', 'آزمون با موفقیت ویرایش شد');
                setTimeout(() => location.reload(), 1000);
            } else {
                const error = await response.json();
                showAlert('danger', error.message || 'خطا در ویرایش آزمون');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('danger', 'خطا در ارتباط با سرور');
        }
    }

    async function deleteExam(examId) {
        if (!confirm('آیا از حذف این آزمون اطمینان دارید؟ این عملیات قابل بازگشت نیست!')) {
            return;
        }

        try {
            const response = await fetch(`/api/exams/${examId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showAlert('success', 'آزمون با موفقیت حذف شد');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('danger', 'خطا در حذف آزمون');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('danger', 'خطا در ارتباط با سرور');
        }
    }

    function showAlert(type, message) {
        const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        document.getElementById('alert-container').innerHTML = alertHtml;
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    document.getElementById('createExamModal').addEventListener('hidden.bs.modal', function () {
        document.getElementById('createExamForm').reset();
        document.getElementById('createDatePreview').style.display = 'none';
    });
</script>
</body>
</html>