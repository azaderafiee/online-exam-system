<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ایجاد سوال جدید</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: #f5f5f5;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/instructor/courses/{id}/questions(id=${course.id})}">
            <i class="fas fa-arrow-right"></i> بازگشت به بانک سوالات
        </a>
    </div>
</nav>

<div class="container-fluid mt-4">

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-plus-circle text-success"></i>
                        ایجاد سوال جدید
                    </h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a th:href="@{/instructor/dashboard}">داشبورد</a></li>
                            <li class="breadcrumb-item">
                                <a th:href="@{/instructor/courses/{id}/questions(id=${course.id})}">بانک سوالات</a>
                            </li>
                            <li class="breadcrumb-item active">سوال جدید</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form id="questionForm">
                        <input type="hidden" id="courseId" th:value="${course.id}">

                        <!-- انتخاب نوع سوال -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">نوع سوال *</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="questionType" id="multipleChoice"
                                       value="MULTIPLE_CHOICE" checked>
                                <label class="btn btn-outline-primary" for="multipleChoice">
                                    <i class="fas fa-list-ul me-2"></i>
                                    چندگزینه‌ای
                                </label>

                                <input type="radio" class="btn-check" name="questionType" id="descriptive"
                                       value="DESCRIPTIVE">
                                <label class="btn btn-outline-warning" for="descriptive">
                                    <i class="fas fa-align-left me-2"></i>
                                    تشریحی
                                </label>
                            </div>
                        </div>

                        <!-- عنوان سوال -->
                        <div class="mb-3">
                            <label for="title" class="form-label fw-bold">عنوان سوال *</label>
                            <input type="text" class="form-control" id="title" required
                                   placeholder="عنوان کوتاه برای سوال (مثلاً: سوال ریاضی 1)">
                            <small class="text-muted">این عنوان برای جستجو و دسته‌بندی استفاده می‌شود</small>
                        </div>

                        <!-- متن سوال -->
                        <div class="mb-3">
                            <label for="questionText" class="form-label fw-bold">صورت سوال *</label>
                            <textarea class="form-control" id="questionText" rows="4" required
                                      placeholder="صورت کامل سوال را وارد کنید..."></textarea>
                        </div>

                        <!-- بخش گزینه‌های چندگزینه‌ای -->
                        <div id="multipleChoiceSection">
                            <hr class="my-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">گزینه‌های سوال</h5>
                                <button type="button" class="btn btn-sm btn-success" id="addOptionBtn">
                                    <i class="fas fa-plus me-1"></i>
                                    افزودن گزینه
                                </button>
                            </div>
                            <div id="optionsContainer">
                                <!-- گزینه‌ها به صورت پویا اضافه می‌شوند -->
                            </div>
                            <small class="text-muted">* دقیقاً یک گزینه باید به عنوان پاسخ صحیح انتخاب شود</small>
                        </div>

                        <!-- بخش سوال تشریحی -->
                        <div id="descriptiveSection" style="display: none;">
                            <hr class="my-4">
                            <h5 class="mb-3">تنظیمات سوال تشریحی</h5>

                            <div class="mb-3">
                                <label for="sampleAnswer" class="form-label">پاسخ نمونه (اختیاری)</label>
                                <textarea class="form-control" id="sampleAnswer" rows="3"
                                          placeholder="پاسخ نمونه برای راهنمایی در تصحیح..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="maxWords" class="form-label">حداکثر تعداد کلمات (اختیاری)</label>
                                <input type="number" class="form-control" id="maxWords" min="1"
                                       placeholder="مثلاً: 200">
                                <small class="text-muted">در صورت عدم تعیین، محدودیتی اعمال نمی‌شود</small>
                            </div>
                        </div>

                        <!-- دکمه‌های عملیات -->
                        <hr class="my-4">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="history.back()">
                                <i class="fas fa-times me-2"></i>
                                انصراف
                            </button>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save me-2"></i>
                                ذخیره سوال
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let optionCount = 0;

    // تغییر نوع سوال
    document.querySelectorAll('input[name="questionType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const isMultipleChoice = this.value === 'MULTIPLE_CHOICE';
            const multipleChoiceSection = document.getElementById('multipleChoiceSection');
            const descriptiveSection = document.getElementById('descriptiveSection');

            multipleChoiceSection.style.display = isMultipleChoice ? 'block' : 'none';
            descriptiveSection.style.display = isMultipleChoice ? 'none' : 'block';

            // مدیریت required attribute برای گزینه‌ها
            const optionInputs = document.querySelectorAll('.option-text');
            optionInputs.forEach(input => {
                if (isMultipleChoice) {
                    input.setAttribute('required', 'required');
                } else {
                    input.removeAttribute('required');
                }
            });

            if (isMultipleChoice && optionCount === 0) {
                addOption(); // اضافه کردن گزینه اول
                addOption(); // اضافه کردن گزینه دوم
            }
        });
    });

    // افزودن گزینه جدید
    document.getElementById('addOptionBtn').addEventListener('click', addOption);

    function addOption() {
        optionCount++;
        const isMultipleChoice = document.querySelector('input[name="questionType"]:checked').value === 'MULTIPLE_CHOICE';
        const requiredAttr = isMultipleChoice ? 'required' : '';

        const optionHtml = `
            <div class="card mb-2" id="option${optionCount}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-1 text-center">
                            <div class="form-check">
                                <input class="form-check-input correct-radio" type="radio"
                                       name="correctOption" value="${optionCount}"
                                       id="correct${optionCount}">
                                <label class="form-check-label" for="correct${optionCount}" title="پاسخ صحیح">
                                    <i class="fas fa-check-circle text-success"></i>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-10">
                            <input type="text" class="form-control option-text"
                                   placeholder="متن گزینه ${optionCount}" ${requiredAttr}>
                        </div>
                        <div class="col-md-1 text-center">
                            <button type="button" class="btn btn-sm btn-danger"
                                    onclick="removeOption(${optionCount})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('optionsContainer').insertAdjacentHTML('beforeend', optionHtml);
    }

    function removeOption(id) {
        if (document.querySelectorAll('.option-text').length <= 2) {
            alert('حداقل دو گزینه برای سوال چندگزینه‌ای لازم است');
            return;
        }
        document.getElementById('option' + id).remove();
    }

    // مقداردهی اولیه
    addOption();
    addOption();

    // ارسال فرم
    document.getElementById('questionForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const questionType = document.querySelector('input[name="questionType"]:checked').value;

        // حذف required از input های hidden (برای سوال تشریحی)
        if (questionType === 'DESCRIPTIVE') {
            document.querySelectorAll('#multipleChoiceSection input').forEach(input => {
                input.removeAttribute('required');
            });
        }

        const courseId = document.getElementById('courseId').value;
        const title = document.getElementById('title').value.trim();
        const questionText = document.getElementById('questionText').value.trim();

        if (!title || !questionText) {
            alert('لطفاً عنوان و صورت سوال را وارد کنید');
            return;
        }

        let requestData = {
            courseId: parseInt(courseId),
            title: title,
            questionText: questionText
        };

        let apiEndpoint;

        if (questionType === 'MULTIPLE_CHOICE') {
            // اعتبارسنجی گزینه‌ها
            const options = [];
            const correctRadio = document.querySelector('input[name="correctOption"]:checked');

            if (!correctRadio) {
                alert('لطفاً یک گزینه را به عنوان پاسخ صحیح انتخاب کنید');
                return;
            }

            const correctOptionId = correctRadio.value;
            document.querySelectorAll('.option-text').forEach((input, index) => {
                if (input.value.trim()) {
                    const optionId = input.closest('.card').id.replace('option', '');
                    options.push({
                        optionText: input.value.trim(),
                        isCorrect: optionId === correctOptionId,
                        orderIndex: index
                    });
                }
            });

            if (options.length < 2) {
                alert('حداقل دو گزینه برای سوال چندگزینه‌ای لازم است');
                return;
            }

            requestData.options = options;
            apiEndpoint = '/api/questions/multiple-choice';

        } else {
            // سوال تشریحی
            requestData.sampleAnswer = document.getElementById('sampleAnswer').value.trim() || null;
            const maxWords = document.getElementById('maxWords').value;
            requestData.maxWords = maxWords ? parseInt(maxWords) : null;
            apiEndpoint = '/api/questions/descriptive';
        }

        // غیرفعال کردن دکمه submit
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>در حال ذخیره...';

        try {
            const response = await fetch(apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            if (response.ok) {
                const result = await response.json();
                alert('سوال با موفقیت ایجاد شد');
                window.location.href = `/instructor/courses/${courseId}/questions`;
            } else {
                const error = await response.json();
                alert('خطا: ' + (error.message || 'خطا در ایجاد سوال'));
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ذخیره سوال';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('خطا در ارتباط با سرور');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ذخیره سوال';
        }
    });
</script>

</body>
</html>